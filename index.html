<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alx Calculator Schedule Orquest</title>
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="info">
        <h1>Alx Calculator Schedule Orquest</h1>
        <input accept=".png, .jpg" type="file" id="image-input" multiple />
        <div class="result">
            <p id="result"></p>
        </div>
        <label for="tarifa-normal">Tarifa por hora normal:</label>
        <input type="number" id="tarifa-normal" placeholder="Tarifa normal" value="7.25" />

        <label for="tarifa-nocturna">Tarifa por hora nocturna:</label>
        <input type="number" id="tarifa-nocturna" placeholder="Tarifa nocturna" value="7.8" />

        <p id="salario-total">Salario total: 0</p>
        <p id="horasNormales">Hora normal: 0</p>
        <p id="horasNocturnas">Hora nocturna: 0</p>
        <p id="horasTotal">Total de horas: 0</p>
        <button onclick="performOCR()">Calcular Salario Semanal</button>
    </div>

    <script>
        async function performOCR() {
            const imageFiles = document.getElementById('image-input').files;
            const tarifaNocturna = parseFloat(document.getElementById('tarifa-nocturna').value);
            const tarifaNormal = parseFloat(document.getElementById('tarifa-normal').value);

            if (!imageFiles.length || isNaN(tarifaNocturna) || isNaN(tarifaNormal)) {
                alert("Por favor selecciona al menos una imagen y asegúrate de ingresar las tarifas.");
                return;
            }

            let horariosTotales = [];

            for (let i = 0; i < imageFiles.length; i++) {
                const formData = new FormData();
                formData.append("apikey", "K84733993588957");
                formData.append("language", "spa");
                formData.append("isOverlayRequired", false);
                formData.append("OCREngine", 2);
                formData.append("file", imageFiles[i]);

                try {
                    const response = await fetch("https://api.ocr.space/parse/image", {
                        method: "POST",
                        body: formData
                    });

                    const result = await response.json();
                    if (result.IsErroredOnProcessing) {
                        document.getElementById('result').innerText = `Error procesando la imagen ${i + 1}`;
                    } else {
                        const parsedText = result.ParsedResults[0].ParsedText;
                        const horarios = filtrarHorarios(parsedText);
                        horariosTotales = horariosTotales.concat(horarios); 
                    }
                } catch (error) {
                    console.error("Error en el procesamiento OCR:", error);
                    document.getElementById('result').innerText = `Error procesando la imagen ${i + 1}`;
                }
            }

            if (horariosTotales.length > 0) {
                document.getElementById('result').innerText = horariosTotales.join('\n');
                calcularSalario(horariosTotales);
            } else {
                document.getElementById('result').innerText = "No se encontraron horarios válidos en las imágenes.";
            }
        }

        function filtrarHorarios(text) {
            const lineas = text.split('\n');
            const horarios = [];
            const regex = /^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/;

            lineas.forEach(linea => {
                if (regex.test(linea.trim())) {
                    horarios.push(linea.trim());
                }
            });

            return horarios;
        }


        function calcularSalario(horariosTotales) {
            const tarifaNormal = parseFloat(document.getElementById('tarifa-normal').value);
            const tarifaNocturna = parseFloat(document.getElementById('tarifa-nocturna').value);

            let salarioTotal = 0;
            let horasNormalesTotal = 0;
            let horasNocturnasTotal = 0;
            let horasTotales = 0;

            horariosTotales.forEach(horario => {
                const [inicio, fin] = horario.split('-');
                const [horaInicio, minutoInicio] = inicio.split(':').map(Number);
                const [horaFin, minutoFin] = fin.split(':').map(Number);

                const totalHoras = calcularHoras(horaInicio, minutoInicio, horaFin, minutoFin);

                const horaInicioNocturna = 22 * 60; 
                const horaFinNocturna = 6 * 60; 

                let inicioEnMinutos = horaInicio * 60 + minutoInicio;
                let finEnMinutos = horaFin * 60 + minutoFin;

                if (finEnMinutos < inicioEnMinutos) {
                    finEnMinutos += 24 * 60; 
                }

                let salarioSegmento = 0;

                if (inicioEnMinutos < horaInicioNocturna && finEnMinutos > horaInicioNocturna) {
                    // Calcular horas normales hasta las 22:00
                    const minutosNormales = horaInicioNocturna - inicioEnMinutos;
                    const horasNormales = minutosNormales / 60;
                    salarioSegmento += horasNormales * tarifaNormal;

                    const minutosNocturnos = finEnMinutos - horaInicioNocturna;
                    const horasNocturnas = minutosNocturnos / 60;
                    salarioSegmento += horasNocturnas * tarifaNocturna;

                    // console.log(`Normal ${salarioSegmento} Horas normales: ${horasNormales}, Horas nocturnas: ${horasNocturnas}`);
                    horasNormalesTotal += horasNormales;
                    horasNocturnasTotal += horasNocturnas;
                }
                else if (inicioEnMinutos >= horaInicioNocturna || inicioEnMinutos < horaFinNocturna) {
                    salarioSegmento = totalHoras * tarifaNocturna;
                    // console.log(`Nocturno ${salarioSegmento} Horas: ${totalHoras}`);
                    horasNocturnasTotal += totalHoras;
                }
                else {
                    salarioSegmento = totalHoras * tarifaNormal;
                    // console.log(`Normal ${salarioSegmento} Horas: ${totalHoras}`);
                    horasNormalesTotal += totalHoras;
                }

                salarioTotal += salarioSegmento;
                horasTotales += totalHoras; 
            });

            document.getElementById('salario-total').innerText = `Salario total: ${salarioTotal.toFixed(2)}`;
            document.getElementById('horasNormales').innerText = `Horas normales: ${horasNormalesTotal.toFixed(2)}`;
            document.getElementById('horasNocturnas').innerText = `Horas nocturnas: ${horasNocturnasTotal.toFixed(2)}`;
            document.getElementById('horasTotal').innerText = `Total de horas: ${horasTotales.toFixed(2)}`;
        }

        function calcularHoras(horaInicio, minutoInicio, horaFin, minutoFin) {
            const inicioEnMinutos = horaInicio * 60 + minutoInicio;
            let finEnMinutos = horaFin * 60 + minutoFin;

            if (finEnMinutos < inicioEnMinutos) {
                finEnMinutos += 24 * 60; 
            }

            const diferenciaEnMinutos = finEnMinutos - inicioEnMinutos;

            return diferenciaEnMinutos / 60;
        }


    </script>
</body>

</html>